---
- name: Install nvm for node version management
  community.general.homebrew:
    name: nvm

- name: Add nvm to .zshrc
  ansible.builtin.blockinfile:
    create: true
    path: ~/.zshrc
    marker: "# {mark} ANSIBLE MANAGED BLOCK FOR NVM"
    mode: "0644"
    block: |
      export NVM_DIR="$HOME/.nvm"
      . "$(brew --prefix nvm)/nvm.sh"

- name: Create NVM setup script from template
  ansible.builtin.template:
    src: nvm_setup.sh.j2
    dest: /tmp/nvm_setup.sh
    mode: '0755'

- name: Install Node.js version
  ansible.builtin.shell: |
    source /tmp/nvm_setup.sh
    nvm install {{ node_version }}
  register: node_nvm_install
  changed_when: "'already installed' not in node_nvm_install.stdout"

- name: Setup to use Node.js version
  ansible.builtin.shell: |
    source /tmp/nvm_setup.sh
    nvm use {{ node_version }}
  register: node_nvm_use
  changed_when: "'Now using' in node_nvm_use.stdout"

- name: Set default node version for NVM
  ansible.builtin.shell: |
    source /tmp/nvm_setup.sh
    nvm alias default node
  register: node_nvm_alias
  changed_when: "'default -> node' in node_nvm_alias.stdout"

- name: Install global npm packages
  ansible.builtin.shell: |
    source /tmp/nvm_setup.sh
    npm install {{ item }} --global
  register: node_npm_install_result
  changed_when: "'added' in node_npm_install_result.stdout"
  loop: "{{ node_npm_global_packages }}"

- name: Clean up temporary NVM setup script
  ansible.builtin.file:
    path: /tmp/nvm_setup.sh
    state: absent

- name: Install vim plugin
  ansible.builtin.git:
    repo: https://github.com/pangloss/vim-javascript.git
    dest: ~/.vim/bundle/vim-javascript
    force: true
