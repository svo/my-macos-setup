- name: Install ChatGPT
  community.general.homebrew_cask:
    name: chatgpt

- name: Install Codex
  community.general.homebrew:
    name: codex

- name: Install Claude
  community.general.homebrew_cask:
    name: claude

- name: Install Claude Code
  ansible.builtin.shell: >
    export NVM_DIR="$HOME/.nvm" &&
    . "$(brew --prefix nvm)/nvm.sh" &&
    nvm use v22.14.0 &&
    npm install @anthropic-ai/claude-code --global
  register: ai_npm_install_claude
  changed_when: "'added' in ai_npm_install_claude.stdout"

- name: Add Context7 MCP Server to Claude Code
  ansible.builtin.shell: >
    claude mcp add --transport http --scope user context7 https://mcp.context7.com/mcp
  register: ai_claude_mcp_add_context7
  changed_when: "'Added MCP server' in ai_claude_mcp_add_context7.stdout or 'Successfully added' in ai_claude_mcp_add_context7.stdout"
  failed_when: false

- name: Add Sequential Thinking MCP Server to Claude Code
  ansible.builtin.shell: >
    claude mcp add --scope user sequential-thinking npx -- -y @modelcontextprotocol/server-sequential-thinking
  register: ai_claude_mcp_add_sequential
  changed_when: "'Added MCP server' in ai_claude_mcp_add_sequential.stdout or 'Successfully added' in ai_claude_mcp_add_sequential.stdout"
  failed_when: false

- name: Add Figma MCP Server to Claude Code
  ansible.builtin.shell: >
    claude mcp add --scope user figma npx -- -y figma-developer-mcp --stdio
  register: ai_claude_mcp_add_figma
  changed_when: "'Added MCP server' in ai_claude_mcp_add_figma.stdout or 'Successfully added' in ai_claude_mcp_add_figma.stdout"
  failed_when: false

- name: Add Notion MCP Server to Claude Code
  ansible.builtin.shell: >
    claude mcp add --scope user notion npx -- -y @notionhq/notion-mcp-server
  register: ai_claude_mcp_add_notion
  changed_when: "'Added MCP server' in ai_claude_mcp_add_notion.stdout or 'Successfully added' in ai_claude_mcp_add_notion.stdout"
  failed_when: false

- name: Install Copilot CLI
  ansible.builtin.shell: >
    export NVM_DIR="$HOME/.nvm" &&
    . "$(brew --prefix nvm)/nvm.sh" &&
    nvm use v22.14.0 &&
    npm install @github/copilot --global
  register: ai_npm_install_copilot
  changed_when: "'added' in ai_npm_install_copilot.stdout"

- name: Ensure Rovo Dev MCP config directory exists
  ansible.builtin.file:
    path: "{{ ansible_env.HOME }}/.rovodev"
    state: directory
    mode: '0755'

- name: Configure MCP servers for Rovo Dev CLI
  ansible.builtin.copy:
    dest: "{{ ansible_env.HOME }}/.rovodev/mcp.json"
    content: |
      {
        "mcpServers": {
          "context7": {
            "url": "https://mcp.context7.com/mcp",
            "transport": "http"
          },
          "sequential-thinking": {
            "command": "npx",
            "args": ["-y", "@modelcontextprotocol/server-sequential-thinking"],
            "transport": "stdio"
          },
          "figma": {
            "command": "npx",
            "args": ["-y", "figma-developer-mcp", "--stdio"],
            "transport": "stdio"
          }
        }
      }
    mode: '0644'
  register: ai_rovodev_mcp_config
  changed_when: ai_rovodev_mcp_config.changed
